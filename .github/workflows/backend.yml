name: backend tests and checkstyle
run-name: Checking backend by @${{ github.actor }}

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  id-token: write
  contents: read
  checks: write

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: adopt
          cache: 'maven'

      - name: Build
        run: mvn package -B -DskipTests -Dskip.installyarn -Dskip.yarn -Dcheckstyle.skip
        env:
          CI: ""

      - name: Test
        run: mvn jacoco:prepare-agent@before-unit-test-execution -B
                 surefire:test -B -Dmaven.test.failure.ignore=true

      - name: Generate JaCoCo report
        run: mvn jacoco:report@after-unit-test-execution -B

      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit tests report
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v2
        with:
          name: unit-tests-jacoco
          path: ${{ github.workspace }}/target/jacoco-output/jacoco-unit-tests.exec

      - name: Unit test Code Coverage Report
        id: jacoco_reporter
        uses: PavanMudigonda/jacoco-reporter@v4.8
        with:
          coverage_results_path: ${{ github.workspace }}/target/site/jacoco-unit-test-coverage-report/jacoco.xml
          coverage_report_name: 'Unit test coverage report'
          coverage_report_title: 'Unit test coverage report'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_check_run: false
          #minimum_coverage: 80
          fail_below_threshold: false
          publish_only_summary: false


  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: adopt
          cache: 'maven'

      - name: Build
        run: mvn package -B -DskipTests -Dskip.installyarn -Dskip.yarn -Dcheckstyle.skip
        env:
          CI: ""

      - name: Test
        run: mvn jacoco:prepare-agent@before-integration-test-execution -B
                 failsafe:integration-test -B -Dmaven.test.failure.ignore=true

      - name: Generate JaCoCo report
        run: mvn jacoco:report@after-integration-test-execution -B

      - name: Test Report
        uses: dorny/test-reporter@v1
        with:
          name: Integration tests report
          path: target/failsafe-reports/TEST-*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v2
        with:
          name: integration-tests-jacoco
          path: ${{ github.workspace }}/target/jacoco-output/jacoco-integration-tests.exec

      - name: Unit test Code Coverage Report
        id: jacoco_reporter
        uses: PavanMudigonda/jacoco-reporter@v4.8
        with:
          coverage_results_path: ${{ github.workspace }}/target/site/jacoco-integration-test-coverage-report/jacoco.xml
          coverage_report_name: 'Integration test coverage report'
          coverage_report_title: 'Integration test coverage report'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_check_run: false
          #minimum_coverage: 80
          fail_below_threshold: false
          publish_only_summary: false


  merge-jacoco-report:
    needs:
      - unit-tests
      - integration-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: adopt
          cache: 'maven'

      - name: Download JaCoCo integration test report
        uses: actions/download-artifact@v2
        with:
          name: integration-tests-jacoco
          path: target/

      - name: Download JaCoCo unit test report
        uses: actions/download-artifact@v2
        with:
          name: unit-tests-jacoco
          path: target/

      - name: Merge JaCoCo reports
        uses: cprudhom/jacoco-merge@v1
        with:
          exec-file: >
            target/jacoco-integration-tests.exec
            target/jacoco-unit-tests.exec
          dest-file:
            target/jacoco-merged.exec

      - name: Upload Merge JaCoCo report
        uses: actions/upload-artifact@v2
        with:
          name: coverage-results-report
          path: target/jacoco-merged.exec
          if-no-files-found: error

      - name: Generate JaCoCo report
        run: mvn jacoco:report@after-integration-test-execution -B

      - name: Merged test Code Coverage Report
        id: jacoco_reporter
        uses: PavanMudigonda/jacoco-reporter@v4.8
        with:
          coverage_results_path: ${{ github.workspace }}/target/site/jacoco-integration-test-coverage-report/jacoco.xml
          coverage_report_name: 'Merged test coverage report'
          coverage_report_title: 'Merged test coverage report'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_check_run: false
          minimum_coverage: 80
          fail_below_threshold: true
          publish_only_summary: false


  checkstyle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: adopt
          cache: 'maven'

      - name: Build and checkstyle
        run: mvn verify -B -DskipTests -Dskip.installyarn -Dskip.yarn checkstyle:checkstyle

      - name: Report
        uses: jwgmeligmeyling/checkstyle-github-action@master
        with:
          name: Checkstyle report
          path: '**/checkstyle-result.xml'
